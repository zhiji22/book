{"version":3,"sources":["index.js"],"names":[],"mappings":";;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"index.js","sourcesContent":["/** !\n * koa-body-parser - index.js\n * Copyright(c) 2014\n * MIT Licensed\n *\n * Authors:\n *   dead_horse <dead_horse@qq.com> (http://deadhorse.me)\n *   fengmk2 <m@fengmk2.com> (http://fengmk2.com)\n */\n\n\n\n/**\n * Module dependencies.\n */\n\nconst parse = require('co-body');\nconst copy = require('copy-to');\n\n/**\n * @param [Object] opts\n *   - {String} jsonLimit default '1mb'\n *   - {String} formLimit default '56kb'\n *   - {string} encoding default 'utf-8'\n *   - {Object} extendTypes\n */\n\nmodule.exports = function(opts) {\n  opts = opts || {};\n  const {detectJSON} = opts;\n  const {onerror} = opts;\n\n  const enableTypes = opts.enableTypes || ['json', 'form'];\n  const enableForm = checkEnable(enableTypes, 'form');\n  const enableJson = checkEnable(enableTypes, 'json');\n  const enableText = checkEnable(enableTypes, 'text');\n  const enableXml = checkEnable(enableTypes, 'xml');\n\n  opts.detectJSON = undefined;\n  opts.onerror = undefined; // eslint-disable-line unicorn/prefer-add-event-listener\n\n  // force co-body return raw body\n  opts.returnRawBody = true;\n\n  // default json types\n  const jsonTypes = [\n    'application/json',\n    'application/json-patch+json',\n    'application/vnd.api+json',\n    'application/csp-report',\n    'application/scim+json'\n  ];\n\n  // default form types\n  const formTypes = ['application/x-www-form-urlencoded'];\n\n  // default text types\n  const textTypes = ['text/plain'];\n\n  // default xml types\n  const xmlTypes = ['text/xml', 'application/xml'];\n\n  const jsonOpts = formatOptions(opts, 'json');\n  const formOpts = formatOptions(opts, 'form');\n  const textOpts = formatOptions(opts, 'text');\n  const xmlOpts = formatOptions(opts, 'xml');\n\n  const extendTypes = opts.extendTypes || {};\n\n  extendType(jsonTypes, extendTypes.json);\n  extendType(formTypes, extendTypes.form);\n  extendType(textTypes, extendTypes.text);\n  extendType(xmlTypes, extendTypes.xml);\n\n  // eslint-disable-next-line func-names\n  return async function bodyParser(ctx, next) {\n    if (ctx.request.body !== undefined || ctx.disableBodyParser)\n      return await next(); // eslint-disable-line no-return-await\n    try {\n      const res = await parseBody(ctx);\n      ctx.request.body = 'parsed' in res ? res.parsed : {};\n      if (ctx.request.rawBody === undefined) ctx.request.rawBody = res.raw;\n    } catch (err) {\n      if (onerror) {\n        onerror(err, ctx);\n      } else {\n        throw err;\n      }\n    }\n\n    await next();\n  };\n\n  async function parseBody(ctx) {\n    if (\n      enableJson &&\n      ((detectJSON && detectJSON(ctx)) || ctx.request.is(jsonTypes))\n    ) {\n      return await parse.json(ctx, jsonOpts); // eslint-disable-line no-return-await\n    }\n\n    if (enableForm && ctx.request.is(formTypes)) {\n      return await parse.form(ctx, formOpts); // eslint-disable-line no-return-await\n    }\n\n    if (enableText && ctx.request.is(textTypes)) {\n      return (await parse.text(ctx, textOpts)) || '';\n    }\n\n    if (enableXml && ctx.request.is(xmlTypes)) {\n      return (await parse.text(ctx, xmlOpts)) || '';\n    }\n\n    return {};\n  }\n};\n\nfunction formatOptions(opts, type) {\n  const res = {};\n  copy(opts).to(res);\n  res.limit = opts[type + 'Limit'];\n  return res;\n}\n\nfunction extendType(original, extend) {\n  if (extend) {\n    if (!Array.isArray(extend)) {\n      extend = [extend];\n    }\n\n    extend.forEach(function(extend) {\n      original.push(extend);\n    });\n  }\n}\n\nfunction checkEnable(types, type) {\n  return types.includes(type);\n}\n"]}